---
// src/pages/blog/[slug].astro
import Layout from '../../layouts/Layout.astro'
import Header from '../../components/Header.astro'
import Footer from '../../components/Footer.astro'
import CosmicBadge from '../../components/CosmicBadge.astro'
import { getBlogPost, getBlogPosts } from '../../lib/cosmic'
import type { BlogPost } from '../../types'

export async function getStaticPaths() {
  const posts = await getBlogPosts()
  return posts.map((post) => ({
    params: { slug: post.slug },
  }))
}

const { slug } = Astro.params
const post = await getBlogPost(slug) as BlogPost | null

if (!post) {
  return Astro.redirect('/404')
}

const bucketSlug = import.meta.env.COSMIC_BUCKET_SLUG as string
const publishDate = post.metadata?.publish_date 
  ? new Date(post.metadata.publish_date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })
  : null
---

<Layout 
  title={`${post.metadata?.title || post.title} - Space Time Navigators Guild`}
  description={post.metadata?.excerpt || ''}
  image={post.metadata?.featured_image?.imgix_url}
>
  <Header />
  
  <main class="container mx-auto px-4 py-16">
    <article class="max-w-4xl mx-auto">
      <div class="mb-8">
        <a href="/blog" class="inline-flex items-center text-cosmic-400 hover:text-cosmic-300 mb-6">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Back to Blog
        </a>
      </div>

      {post.metadata?.featured_image && (
        <img 
          src={`${post.metadata.featured_image.imgix_url}?w=1600&h=800&fit=crop&auto=format,compress`}
          alt={post.title}
          width="800"
          height="400"
          class="w-full h-96 object-cover rounded-xl mb-8"
        />
      )}

      <header class="mb-8">
        <h1 class="text-5xl font-bold mb-4">
          {post.metadata?.title || post.title}
        </h1>
        {publishDate && (
          <time class="text-cosmic-400 text-lg">
            {publishDate}
          </time>
        )}
      </header>

      {post.metadata?.excerpt && (
        <div class="text-xl text-cosmic-300 mb-8 pb-8 border-b border-cosmic-800">
          {post.metadata.excerpt}
        </div>
      )}

      {post.metadata?.content && (
        <div class="prose prose-invert prose-cosmic prose-lg max-w-none">
          <div set:html={post.metadata.content} />
        </div>
      )}

      <div class="mt-12 pt-8 border-t border-cosmic-800">
        <a 
          href="/blog"
          class="inline-block px-8 py-3 bg-cosmic-800 hover:bg-cosmic-700 rounded-lg font-semibold transition-colors"
        >
          ‚Üê Back to All Posts
        </a>
      </div>
    </article>
  </main>

  <Footer />
  <CosmicBadge bucketSlug={bucketSlug} />
</Layout>